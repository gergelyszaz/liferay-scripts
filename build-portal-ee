# For building a certain branch from liferay-portal-ee.
# Setup: see update script
# Usage:
#	set the correct java version

# check if parameter was given
if [ $# -eq 0 ]
  then
	echo "No branchname supplied"
	exit 1
fi

# save current state and checkout branch
BRANCH=$1
SPATH=$LIFERAY_GITHUB
cd $SPATH
ORIGINAL=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
git stash
git checkout $BRANCH

# create app.server.<username>.properties
cd $SPATH
DPATH=$LIFERAY_BUILD/$BRANCH
USER=$(whoami)
echo "app.server.parent.dir=$DPATH" > app.server.$USER.properties

# build with tomcat
DPATH=$LIFERAY_BUILD/$BRANCH
rm -r $DPATH
mkdir -p $DPATH
cd $SPATH

set RELEASE_VERSION=RELEASE_7
set RELEASE_INFO=\portal-kernel\src\com\liferay\portal\kernel\util\ReleaseInfo.java
set JAVA_HOME=$JAVA7%
find "%RELEASE_VERSION%" %PORTAL_PATH%%RELEASE_INFO%
IF NOT ERRORLEVEL 1 set JAVA_HOME=%JAVA_8%

if [ $BRANCH = "ee-6.2.x" ] || [ $BRANCH = "ee-6.1.x" ]
then
	export JAVA_HOME=$JAVA7	
	export PATH=$JAVA_HOME/bin:$PATH
fi
java -version

ant -buildfile build-dist.xml unzip-tomcat
ant all

# restore repo
cd $SPATH
git clean -fd
git reset --hard HEAD
git checkout $ORIGINAL
git stash apply

# create portal-ext.properties
cd $DPATH
echo "liferay.home=$DPATH
setup.wizard.enabled=false
users.reminder.queries.enabled=false
users.reminder.queries.custom.question.enabled=false
terms.of.use.required=false" > portal-ext.properties
