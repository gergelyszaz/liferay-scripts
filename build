# Author: Gergely Sz√°z <gergely.szaz@liferay.com>
# Usage: run this from the liferay source folder.
# Environmental variables: 
# 	LIFERAY_BUILD: build folder path, built portals go here 
#	JAVA7: java 7 jdk path
#	JAVA8: java 8 jdk path


# get branch name
BRANCH=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
echo "Building $BRANCH"

# clean build folder
DPATH=$LIFERAY_BUILD/$BRANCH
rm -r $DPATH
mkdir -p $DPATH

# set java version
JAVA_VERSION=$(cat "build.properties" | grep "ant.build.javac.source" | cut -d \= -f 2  )
echo "Java version in build.properties $JAVA_VERSION"
case $JAVA_VERSION in
1.8)
    export JAVA_HOME=$JAVA8;;
1.[6-7])
    export JAVA_HOME=$JAVA7;;
esac
export PATH=$JAVA_HOME/bin:$PATH
echo "Using $(java -version  2>&1 >/dev/null | grep version)"

echo
echo

# build
USER=$(whoami)
echo "app.server.parent.dir=$DPATH" > app.server.$USER.properties
ant -buildfile build-dist.xml unzip-tomcat
ant all

# create portal-ext.properties
cd $DPATH
echo "liferay.home=$DPATH
setup.wizard.enabled=false
users.reminder.queries.enabled=false
users.reminder.queries.custom.question.enabled=false
terms.of.use.required=false" > portal-ext.properties
