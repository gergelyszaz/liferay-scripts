# Author: Gergely SzÃ¡z
# Usage: run this from the liferay source folder.
# Environmental variables: 
# 	LIFERAY_BUILD: path to the build folder
#	JAVA7: java 7 path
#	JAVA8: java 8 path

# get branch name
BRANCH=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p')
echo "Building $BRANCH"

# clean build folder
DPATH=$LIFERAY_BUILD/$BRANCH
rm -r $DPATH
mkdir -p $DPATH

# set java version
RELEASE_VERSION="RELEASE_7"
RELEASE_INFO=portal-kernel/src/com/liferay/portal/kernel/util/ReleaseInfo.java
if grep -q $RELEASE_VERSION $RELEASE_INFO
then
    export JAVA_HOME=$JAVA8
else
    export JAVA_HOME=$JAVA7	
fi
export PATH=$JAVA_HOME/bin:$PATH
java -version

# build
USER=$(whoami)
echo "app.server.parent.dir=$DPATH" > app.server.$USER.properties
ant -buildfile build-dist.xml unzip-tomcat
ant all

# create portal-ext.properties
cd $DPATH
echo "liferay.home=$DPATH
setup.wizard.enabled=false
users.reminder.queries.enabled=false
users.reminder.queries.custom.question.enabled=false
terms.of.use.required=false" > portal-ext.properties
