# Author: Gergely Sz√°z <gergely.szaz@liferay.com>
# Usage: run this from the liferay source folder.
# Environmental variables: 
# 	LIFERAY_BUILD: build folder path, built portals go here 
#	JAVA7: java 7 jdk path
#	JAVA8: java 8 jdk path


# get branch name
BRANCH=$(branch)
echo "Building $BRANCH"

# clean build folder
DPATH=$LIFERAY_BUILD/$BRANCH
rm -r $DPATH
mkdir -p $DPATH

JAVA_HOME=$(java-version)
export PATH=$JAVA_HOME/bin:$PATH
echo "Using $(java -version  2>&1 | grep version)"

echo
echo

# build
USER=$(whoami)
echo "app.server.parent.dir=$DPATH" > app.server.$USER.properties

[ -f build-ext ] && build-ext

ant -buildfile build-dist.xml unzip-tomcat
ant all

# create portal-ext.properties
cd $DPATH
echo "
liferay.home=$DPATH
setup.wizard.enabled=false
users.reminder.queries.enabled=false
users.reminder.queries.custom.question.enabled=false
terms.of.use.required=false
" > portal-ext.properties
